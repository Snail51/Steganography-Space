import{Reader as e}from"./reader.js";import{URICompressor as t}from"./compression.js";import{x2x8 as a}from"./base2-base8.js";import{Provider as r}from"./provider.js";import{Base8Sub as s}from"./base8-substituter.js";export class Steganospace{constructor(){this.maxSize=104857600,this.messageReader=new e("message"),this.coverReader=new e("cover"),this.decodeReader=new e("ciphertext"),this.encodeDownload=new r("encode_download"),this.decodeDownload=new r("decode_download"),this.converter=new a,this.substitutor=new s,setInterval((function(){document.getElementById("encode_button").disabled=!this.encodeValidate()}).bind(this),100),setInterval((function(){var e=this.decodeReader.element.files;e=e.length>0,document.getElementById("decode_button").disabled=!this.decodeValidate()}).bind(this),100)}async encode(){this.encodeDownload.clear(),await this.sleep(1e3);var e=await this.messageReader.readSingleAsBinary(),a=Math.floor(e.data.length/8);if(e.data=t.compress(e.data),null==e.data){this.encodeDownload.error(),await this.sleep(1e3);return}var r=Math.floor(e.data.length/8);console.log("Compression reduced file from "+a+" bytes to "+r+" bytes ("+r/a+")"),e.data=this.converter.to8(e.data);var s=await this.coverReader.readSingleAsText(),d=this.substitutor.encode(e.data,s.data);if(null==d){this.encodeDownload.error(),await this.sleep(1e3);return}this.encodeDownload.provide(s.name,s.type,d)}async decode(){this.decodeDownload.clear(),await this.sleep(1e3);var e=await this.decodeReader.readSingleAsText();if(e.data=this.substitutor.decode(e.data),e.data=this.converter.to2(e.data),null==e.data||(e.data=t.decompress(e.data),null==e.data)){this.decodeDownload.error(),await this.sleep(1e3);return}var a=e.data.substring(e.data.length-32,e.data.length-16);a=Number.parseInt(a,2);var r=e.data.substring(e.data.length-16,e.data.length-0);r=Number.parseInt(r,2);var s=e.data.substring(e.data.length-32-8*r-8*a,e.data.length-32-8*r);s=decodeURIComponent(s=this.binaryToString(s));var d=e.data.substring(e.data.length-32-8*r,e.data.length-32);d=decodeURIComponent(d=this.binaryToString(d)),e.data=e.data.substring(0,e.data.length-32-8*a-8*r),e.data=this.binaryToU8(e.data),this.decodeDownload.provide(s,d,e.data)}binaryToString(e){for(var t="",a=0;a<e.length;a+=8)t+=String.fromCodePoint(Number.parseInt(e.substring(a,a+8),2));return t}binaryToU8(e){var a=t.splitIntoChunks(e,8),r=[];for(var s of a)r.push(Number.parseInt(s,2));return new Uint8Array(r)}sleep(e=0){return new Promise(t=>setTimeout(t,e))}encodeValidate(){try{var e=1==this.messageReader.element.files.length,t=1==this.coverReader.element.files.length,a=this.messageReader.element.files[0].size<this.maxSize,r=this.coverReader.element.files[0].size<this.maxSize,s="text/plain"==this.coverReader.element.files[0].type;return e&&a&&t&&r&&s}catch{return!1}}decodeValidate(){try{var e=1==this.decodeReader.element.files.length,t=this.decodeReader.element.files[0].size<this.maxSize,a="text/plain"==this.decodeReader.element.files[0].type;return e&&t&&a}catch{return!1}}}