import{Reader as e}from"./reader.js";import{URICompressor as t}from"./compression.js";import{x2x8 as a}from"./base2-base8.js";import{Provider as r}from"./provider.js";import{Base8Sub as d}from"./base8-substituter.js";export class Steganospace{constructor(){this.messageReader=new e("message"),this.coverReader=new e("cover"),this.decodeReader=new e("ciphertext"),this.encodeDownload=new r("encode_download"),this.decodeDownload=new r("decode_download"),this.converter=new a,this.substitutor=new d,setInterval((function(){var e=this.messageReader.element.files;e=e.length>0;var t=this.coverReader.element.files;t=t.length>0;var a=e&&t;document.getElementById("encode_button").disabled=!a}).bind(this),100),setInterval((function(){var e=this.decodeReader.element.files;e=e.length>0,document.getElementById("decode_button").disabled=!e}).bind(this),100)}async encode(){var e=await this.messageReader.readSingleAsBinary(),a=Math.floor(e.data.length/8);e.data=t.compress(e.data);var r=Math.floor(e.data.length/8);console.log("Compression reduced file from "+a+" bytes to "+r+" bytes ("+r/a+")"),e.data=this.converter.to8(e.data);var d=await this.coverReader.readSingleAsText(),s=this.substitutor.encode(e.data,d.data);this.encodeDownload.provide(d.name,d.type,s)}async decode(){var e=await this.decodeReader.readSingleAsText();e.data=this.substitutor.decode(e.data),e.data=this.converter.to2(e.data),e.data=t.decompress(e.data);var a=e.data.substring(e.data.length-32,e.data.length-16);a=Number.parseInt(a,2);var r=e.data.substring(e.data.length-16,e.data.length-0);r=Number.parseInt(r,2);var d=e.data.substring(e.data.length-32-8*r-8*a,e.data.length-32-8*r);d=decodeURIComponent(d=this.binaryToString(d));var s=e.data.substring(e.data.length-32-8*r,e.data.length-32);s=decodeURIComponent(s=this.binaryToString(s)),e.data=e.data.substring(0,e.data.length-32-8*a-8*r),e.data=this.binaryToU8(e.data),this.decodeDownload.provide(d,s,e.data)}binaryToString(e){for(var t="",a=0;a<e.length;a+=8)t+=String.fromCodePoint(Number.parseInt(e.substring(a,a+8),2));return t}binaryToU8(e){var a=t.splitIntoChunks(e,8),r=[];for(var d of a)r.push(Number.parseInt(d,2));return new Uint8Array(r)}}