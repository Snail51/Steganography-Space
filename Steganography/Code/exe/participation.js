export class Participation{constructor(){this.reader=new Reader,this.messages="",this.users="",this.state="NOT INIT",this.weeks=[]}execution(e){switch(e&&(this.state="INIT"),this.state){case"INIT":this.preReadMessages();break;case"DATA":this.buildObj();break;case"OBJ":this.buildWeeks();break;case"PROCESS":this.writeReport();break;default:console.warn("Unkown switch case "+this.state+" reached!")}}writeReport(){document.getElementById("result").innerHTML="";var e="";for(var s of this.weeks){for(var t of(s.users.sort(),e+="Week "+s.sundayOffset+":\n",s.users))e+=t+", ";e=e.substring(0,e.length-2),e+="\n\n"}document.getElementById("result").innerHTML=e}buildWeeks(){for(var e of(this.weeks=[],this.messages))this.subWeek(e.ts.week,e.user);var s=new Date(document.getElementById("zero").value);for(var t of(s=Timestamp.countSundays(s.getTime()),this.weeks))t.sundayOffset=t.sundayOffset-s;this.state="PROCESS",window.main.execution(!1)}subWeek(e,s){-1!=this.getWeekIndex(e)||this.weeks.push(new Week(e)),this.weeks[this.getWeekIndex(e)].addUser(s)}getWeekIndex(e){for(var s=0;s<this.weeks.length;s++)if(this.weeks[s].sundayOffset==e)return s;return -1}buildObj(){this.users=new UserDictionary(this.users);var e=[];for(var s of this.messages)if(null!=s.text&&""!=s.text){var t=this.users.getName(s.user);e.push(new Message(t,s.ts,s.text))}this.messages=e,this.state="OBJ",window.main.execution(!1)}preReadMessages(){window.main.reader.readAllFilesFromForm("data",window.main.postReadMessages)}postReadMessages(){window.main.messages=window.main.reader.result,window.main.messages=JSON.parse(window.main.messages),window.main.preReadUsers()}preReadUsers(){window.main.reader.readAllFilesFromForm("users",window.main.postReadUsers)}postReadUsers(){window.main.users=window.main.reader.result,window.main.users=JSON.parse(window.main.users),window.main.state="DATA",window.main.execution(!1)}}class Reader{constructor(){this.state="NOT INIT",this.files=[],this.result="",this.callback}elementSetup(e,s){if(this.state="NOT INIT",this.callback=s,this.files=document.getElementById(e).files,null==this.files){console.error("Element with ID "+e+" does not have a .files attribute!"),this.result="ERROR_NO-ATTRIBUTE";return}if(0==this.files.length){console.error("Element with ID "+e+" has 0 files assigned!"),this.result="ERROR_NO-FILES";return}this.result=""}readAllFilesFromForm(e,s){this.elementSetup(e,s);for(var t=[],r=0;r<this.files.length;r++)t.push(this.subRead(this.files[r]));this.state="READY",Promise.all(t).then(e=>{this.state="RUNNING";for(let s=0;s<e.length;s++)e[s]=e[s].substring(2,e[s].length-2),this.result+=e[s]+",\n";this.result="[\n"+this.result.substring(0,this.result.length-2)+"\n]",this.state="DONE",this.callback()})}subRead(e){return new Promise((s,t)=>{let r=new FileReader;r.onload=function(e){s(e.target.result)},r.onerror=function(e){t(e)},r.readAsText(e)})}}class Message{constructor(e,s,t){this.user=e,this.ts=new Timestamp(s),this.text=t}}class User{constructor(e,s,t){this.id=e,this.handle=s,this.name=t}}class Timestamp{constructor(e){this.unix=e.split("."),this.unix=this.unix[0],this.unix=1e3*this.unix;var s=new Date(this.unix);s=(s=s.toISOString()).substring(0,10),this.date=s,this.week=Timestamp.countSundays(this.unix)}static countSundays(e){for(var s=new Date(e),t=0,r=new Date(s.getFullYear(),0,1);r<=s;r.setDate(r.getDate()+1))0===r.getDay()&&t++;return t}}class UserDictionary{constructor(e){this.users=[];var s=e;for(var t of s)this.users.push(new User(t.id,t.name,t.profile.display_name))}getName(e){for(var s=0;s<this.users.length;s++)if(this.users[s].id==e){if(""!=this.users[s].name)return this.users[s].name;return this.users[s].handle}return null}}class Week{constructor(e){this.sundayOffset=e,this.users=[]}addUser(e){var s=!1;for(var t of this.users)t==e&&(s=!0);s||this.users.push(e)}}